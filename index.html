
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planer Taekwondo (by Carlos Mata)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Incluir a biblioteca date-fns para manipulação de datas -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/cdn.min.js"></script>
    <!-- Adicionar locale pt para date-fns -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/locale/pt/cdn.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* gray-900 */
            color: #d1d5db; /* gray-300 */
        }
        .glass-effect {
            background: rgba(31, 41, 55, 0.7); /* gray-800 with opacity */
            backdrop-filter: blur(10px);
            border: 1px solid rgba(55, 65, 81, 0.3); /* gray-700 with opacity */
        }
        .modal { display: none; }
        .modal.flex { display: flex; }
        .modal-content { max-height: 90vh; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 600; transition: background-color 0.2s; cursor: pointer; }
        .btn-primary { background-color: #4f46e5; color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:disabled { background-color: #6b7280; cursor: not-allowed; }
        .btn-secondary { background-color: #4b5563; color: white; }
        .btn-secondary:hover { background-color: #6b7280; }
        .btn-danger { background-color: #dc2626; color: white; }
        .btn-danger:hover { background-color: #b91c1c; }
        .btn-teal { background-color: #0d9488; color: white; }
        .btn-teal:hover { background-color: #0f766e; }
        .nav-button.active {
             background-color: #4f46e5;
             color: white;
        }
        .session-square {
            aspect-ratio: 1 / 1;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            font-size: 0.65rem;
            line-height: 1;
        }
        .session-square.logged::after {
            content: '';
            position: absolute;
            top: 5px;
            right: 5px;
            width: 8px;
            height: 8px;
            background-color: #3b82f6; /* blue-500 */
            border-radius: 50%;
            border: 1px solid #1f2937; /* gray-800 */
        }
        #toast-container {
            position: fixed;
            top: 1.25rem;
            right: 1.25rem;
            z-index: 50;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        /* Estilos para a grelha do macrociclo */
        .macro-grid {
            display: grid;
            /* Mais colunas para acomodar mais semanas visíveis */
             grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); /* Mais flexível */
            gap: 0.5rem;
        }

        .macro-month-header {
            /* Ocupa a largura total da grelha atual */
             grid-column: 1 / -1;
            text-align: left;
            font-size: 1rem; /* text-base */
            font-weight: 600; /* font-semibold */
            color: #e5e7eb; /* gray-200 */
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            border-bottom: 1px solid #4b5563; /* gray-600 */
            padding-bottom: 0.25rem;
        }
         /* Garante que o primeiro header não tem margem de topo extra */
        .macro-month-header:first-of-type {
            margin-top: 0;
        }

        .macro-week {
            background-color: #374151; /* gray-700 */
            border-radius: 0.375rem; /* rounded-md */
            padding: 0.5rem;
            text-align: center;
            font-size: 0.75rem; /* text-xs */
            font-weight: 600; /* font-semibold */
            aspect-ratio: 1 / 1; /* Quadrado */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            cursor: pointer; /* Adiciona cursor para indicar interatividade futura */
            transition: background-color 0.2s, transform 0.1s ease-in-out;
             border-top: 4px solid transparent; /* Espaço para a borda do mesociclo */
        }
         .macro-week:hover {
            transform: scale(1.05); /* Efeito de zoom no hover */
            background-color: #4b5563; /* gray-600 */
        }
        .macro-week span.week-number {
             font-size: 0.8rem; /* Aumenta ligeiramente o número da semana */
        }
         .macro-week span.microcycle {
            font-size: 0.65rem; /* Tamanho para abreviatura do microciclo */
            font-weight: bold;
            margin-top: 2px;
            color: #f3f4f6; /* gray-100 - para contraste com fundos coloridos */
        }
        .macro-week span.week-date {
            font-size: 0.6rem; /* Reduz tamanho da data */
            color: #9ca3af; /* gray-400 */
            margin-top: 2px;
        }
        /* Cores para períodos e mesociclos (exemplo) */
        /* Aplicar cores de fundo para períodos */
        .period-preparatorio { background-color: #059669 !important; color: white !important;} /* emerald-600 */
        .period-competitivo { background-color: #dc2626 !important; color: white !important;} /* red-600 */
        .period-transitorio { background-color: #d97706 !important; color: white !important;} /* amber-600 */
         /* Cor de fallback ou default */
         .period-undefined { background-color: #374151 !important; color: #d1d5db !important; }

        /* Aplicar bordas TOP para mesociclos */
        .meso-base { border-top-color: #3b82f6; } /* blue-500 */
        .meso-desenvolvimento { border-top-color: #10b981; } /* emerald-500 */
        .meso-controlo { border-top-color: #f59e0b; } /* amber-500 */
        .meso-competicao { border-top-color: #ef4444; } /* red-500 */
        .meso-manutencao { border-top-color: #8b5cf6; } /* violet-500 */
         /* Borda default ou sem mesociclo */
        .meso-undefined { border-top-color: transparent; }

        /* Estilo para eventos (ex: ponto colorido) */
        .event-dot {
            position: absolute;
            bottom: 5px;
            left: 5px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            border: 1px solid #1f2937; /* gray-800 */
        }
        .event-competition { background-color: #facc15; } /* yellow-400 */
        .event-evaluation { background-color: #a78bfa; } /* violet-400 */
        .event-other { background-color: #60a5fa; } /* blue-400 */

        /* Indicador de Objetivo */
        .objective-indicator {
             position: absolute;
             top: 5px;
             left: 5px;
             width: 8px;
             height: 8px;
             border-radius: 50%;
             background-color: #f472b6; /* pink-400 */
             border: 1px solid #1f2937;
        }

    </style>
</head>
<body class="min-h-screen">

    <div id="app" style="display: none;">
        <!-- Navigation Bar -->
        <nav class="glass-effect sticky top-0 z-40">
           <!-- ... (código da navbar existente, sem alterações) ... -->
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex-shrink-0">
                        <div>
                            <h1 class="text-xl font-bold text-white">Planer Taekwondo <span class="text-base font-normal text-gray-300">(by Carlos Mata)</span></h1>
                             <div class="flex items-center gap-2">
                                 <span class="text-xs font-medium text-gray-400">ID de Treinador:</span>
                                 <span id="user-id-display" class="text-xs font-semibold text-gray-300"></span>
                             </div>
                        </div>
                    </div>
                    <!-- Menu para PC (escondido em ecrãs pequenos) -->
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="#" id="nav-meus-planos" onclick="window.showView('training-plans-list-view')" class="nav-button text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Os Meus Planos</a>
                            <a href="#" id="nav-macrociclo" onclick="window.showView('macrociclo-view')" class="nav-button text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Macrociclo</a>
                            <a href="#" id="nav-novo-plano" onclick="window.createNewTrainingPlan()" class="nav-button text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Novo Plano</a>
                            <a href="#" id="nav-novo-exercicio" onclick="window.createNewExercise()" class="nav-button text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Novo Exercício</a>
                            <a href="#" id="nav-biblioteca" onclick="window.showView('exercise-library-view')" class="nav-button text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Biblioteca Partilhada</a>
                            <a href="#" id="nav-galeria" onclick="window.showView('image-gallery-view')" class="nav-button text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Galeria de Imagens</a>
                            <a href="#" id="nav-mapa" onclick="window.showView('content-map-view')" class="nav-button text-gray-300 hover:bg-gray-700 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Mapa de Conteúdos</a>
                        </div>
                    </div>
                    <!-- Botão Hambúrguer (só aparece em ecrãs pequenos) -->
                    <div class="-mr-2 flex md:hidden">
                        <button id="mobile-menu-button" type="button" class="bg-gray-800 inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-white hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-white">
                            <span class="sr-only">Abrir menu principal</span>
                            <svg class="block h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
             <!-- Menu Móvel (escondido por defeito) -->
            <div class="md:hidden hidden" id="mobile-menu">
                <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                    <a href="#" onclick="window.showView('training-plans-list-view'); window.toggleMobileMenu();" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Os Meus Planos</a>
                    <a href="#" onclick="window.showView('macrociclo-view'); window.toggleMobileMenu();" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Macrociclo</a>
                    <a href="#" onclick="window.createNewTrainingPlan(); window.toggleMobileMenu();" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Novo Plano</a>
                    <a href="#" onclick="window.createNewExercise(); window.toggleMobileMenu();" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Novo Exercício</a>
                    <a href="#" onclick="window.showView('exercise-library-view'); window.toggleMobileMenu();" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Biblioteca Partilhada</a>
                    <a href="#" onclick="window.showView('image-gallery-view'); window.toggleMobileMenu();" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Galeria de Imagens</a>
                    <a href="#" onclick="window.showView('content-map-view'); window.toggleMobileMenu();" class="text-gray-300 hover:bg-gray-700 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Mapa de Conteúdos</a>
                </div>
            </div>
        </nav>

        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Training Plans List View -->
            <div id="training-plans-list-view" class="p-4 md:p-0 view">
                <!-- ... (código existente da lista de planos) ... -->
                <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-semibold text-white">Os Meus Planos de Treino (Privados)</h2>
                     <button onclick="window.createNewTrainingPlan()" class="btn btn-primary">Criar Novo Plano</button>
                 </div>
                 <div id="plans-list-container" class="space-y-4"></div>
            </div>

            <!-- Training Plan Editor View -->
            <div id="training-plan-editor-view" class="p-4 md:p-8 glass-effect rounded-lg hidden view">
               <!-- ... (código existente do editor de planos) ... -->
                 <h2 class="text-3xl font-bold text-white mb-6" id="editor-title">Novo Plano de Treino</h2>
                 <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8" id="plan-metadata-grid"></div>
                 <div id="training-plan-sections" class="space-y-8"></div>
                 <div class="mt-8 flex flex-wrap gap-4 justify-end items-center">
                      <div class="flex items-center gap-2 mr-4">
                          <span class="text-sm font-medium text-gray-400">Tempo Total de Treino:</span>
                          <div id="footer-calculated-total-time" class="text-lg font-bold text-white bg-gray-900 px-3 py-1 rounded-md">0 min</div>
                      </div>
                     <button onclick="window.showView('training-plans-list-view')" class="btn btn-secondary">Cancelar</button>
                     <button onclick="window.exportPlanToPDF()" class="btn btn-teal">Exportar PDF</button>
                     <button id="save-plan-btn" onclick="window.saveTrainingPlan()" class="btn btn-primary">Guardar Plano</button>
                 </div>
            </div>

            <!-- Exercise Library View -->
            <div id="exercise-library-view" class="p-4 md:p-8 glass-effect rounded-lg hidden view">
               <!-- ... (código existente da biblioteca) ... -->
                 <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-semibold text-white">Biblioteca de Exercícios (Partilhada)</h2>
                     <button onclick="window.createNewExercise()" class="btn btn-primary">Adicionar Exercício</button>
                 </div>
                 <div id="exercise-list-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-8"></div>
            </div>

            <!-- Exercise Editor View -->
            <div id="exercise-editor-view" class="p-4 md:p-8 glass-effect rounded-lg hidden view">
                <!-- ... (código existente do editor de exercícios) ... -->
                 <form id="exercise-form" class="space-y-4"></form>
                 <div id="exercise-editor-footer" class="mt-8 flex flex-wrap gap-4 justify-end">
                     {/* <!-- Buttons will be rendered here by JS --> */}
                 </div>
            </div>

            <!-- Image Gallery View -->
            <div id="image-gallery-view" class="p-4 md:p-8 glass-effect rounded-lg hidden view">
               <!-- ... (código existente da galeria) ... -->
                 <div class="flex justify-between items-center mb-6">
                     <h2 class="text-2xl font-semibold text-white">Galeria de Imagens</h2>
                     <label for="gallery-upload-input" class="btn btn-primary">
                         Carregar Nova Imagem
                         <input type="file" id="gallery-upload-input" class="hidden" accept="image/jpeg,image/png,image/gif,video/mp4,video/webm" onchange="window.handleGalleryUpload(this.files[0])">
                     </label>
                 </div>
                 <div id="image-gallery-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
            </div>

             <!-- Content Map View -->
            <div id="content-map-view" class="p-4 md:p-8 glass-effect rounded-lg hidden view">
                <!-- ... (código existente do mapa de conteúdos) ... -->
                 <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                     <h2 class="text-2xl font-semibold text-white">Mapa de Conteúdos Trabalhados</h2>
                     <div class="flex gap-2">
                         <button id="add-sessions-btn" class="btn btn-secondary">+12 Sessões</button>
                         <button id="generate-chart-btn" class="btn btn-primary">Gerar Gráfico</button>
                     </div>
                 </div>

                 <div class="mb-6" id="chart-container" style="display: none;">
                     <canvas id="content-chart"></canvas>
                     <div id="chart-legend" class="flex justify-center flex-wrap gap-x-4 gap-y-2 mt-4 text-xs">
                          <div class="flex items-center gap-2">
                              <span class="w-4 h-4 rounded" style="background-color: rgba(59, 130, 246, 0.8);"></span>
                              <span>Capacidades Físicas</span>
                          </div>
                          <div class="flex items-center gap-2">
                              <span class="w-4 h-4 rounded" style="background-color: rgba(16, 185, 129, 0.8);"></span>
                              <span>Capacidades Coordenativas</span>
                          </div>
                          <div class="flex items-center gap-2">
                              <span class="w-4 h-4 rounded" style="background-color: rgba(239, 68, 68, 0.8);"></span>
                              <span>Conteúdos Técnico Táticos</span>
                          </div>
                          <div class="flex items-center gap-2">
                              <span class="w-4 h-4 rounded" style="background-color: rgba(168, 85, 247, 0.8);"></span>
                              <span>Capacidades Psicológicas/cognitivas</span>
                          </div>
                     </div>
                 </div>

                 <div id="content-grid-container" class="grid grid-cols-8 md:grid-cols-14 gap-2">
                     {/* <!-- Session squares will be generated by JS --> */}
                 </div>
            </div>

            <!-- NOVA VIEW: Macrociclo -->
            <div id="macrociclo-view" class="p-4 md:p-8 glass-effect rounded-lg hidden view">
                <div class="flex flex-wrap gap-4 justify-between items-center mb-6">
                    <h2 class="text-2xl font-semibold text-white">Planeamento do Macrociclo</h2>
                    <button id="save-macrociclo-btn" onclick="window.saveMacrociclo()" class="btn btn-primary">Guardar Macrociclo</button>
                </div>

                <!-- Controles do Macrociclo -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 p-4 bg-gray-800/50 rounded-lg">
                    <div>
                        <label for="macro-season" class="block text-sm font-medium text-gray-400 mb-1">Época</label>
                        <input type="text" id="macro-season" placeholder="Ex: 2025/2026" class="w-full text-sm bg-gray-700 border-gray-600 rounded-md py-1 px-2 text-white h-[34px]" oninput="window.updateMacrocicloState('season', this.value)">
                    </div>
                    <div>
                        <label for="macro-start-date" class="block text-sm font-medium text-gray-400 mb-1">Data de Início</label>
                        <input type="date" id="macro-start-date" class="w-full text-sm bg-gray-700 border-gray-600 rounded-md py-1 px-2 text-white h-[34px]" onchange="window.updateMacrocicloState('startDate', this.value); window.renderMacrocicloGrid()">
                    </div>
                    <div>
                        <label for="macro-end-date" class="block text-sm font-medium text-gray-400 mb-1">Data de Fim</label>
                        <input type="date" id="macro-end-date" class="w-full text-sm bg-gray-700 border-gray-600 rounded-md py-1 px-2 text-white h-[34px]" onchange="window.updateMacrocicloState('endDate', this.value); window.renderMacrocicloGrid()">
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="flex flex-wrap gap-2 mb-6">
                    <!-- TODO: Implementar Modais para estas ações -->
                     <button onclick="window.openPeriodModal()" class="btn btn-secondary text-sm">Gerir Períodos</button>
                     <button onclick="window.openMesocycleModal()" class="btn btn-secondary text-sm">Gerir Mesociclos</button>
                     <button onclick="window.openEventModal()" class="btn btn-secondary text-sm">Gerir Eventos</button>
                </div>

                <!-- Grelha de Visualização -->
                 <div id="macrociclo-grid-container" class="macro-grid bg-gray-900/50 p-4 rounded-lg overflow-x-auto min-h-[200px]">
                    {/* <!-- Semanas serão renderizadas aqui pelo JS --> */}
                    <p class="text-gray-500 italic col-span-full text-center">Defina as datas de início e fim para visualizar as semanas.</p>
                </div>
            </div>

        </main>

        <!-- Modals -->
        <!-- ... (todos os modais existentes: image-gallery, content-log, exercise-library, confirmation, firebase-rules) ... -->
        <div id="image-gallery-modal" class="modal fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
             <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-4xl transform transition-all">
                 <div class="flex justify-between items-center mb-4">
                     <h3 class="text-xl font-medium text-white">Selecionar Imagem da Galeria</h3>
                     <button onclick="window.hideImageGalleryModal()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                 </div>
                 <div id="image-gallery-modal-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-4 overflow-y-auto max-h-[60vh]">
                     {/* <!-- Images for selection will be loaded here --> */}
                 </div>
             </div>
         </div>

         <div id="content-log-modal" class="modal fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
             <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-2xl transform transition-all">
                 <div class="flex justify-between items-center mb-4">
                     <h3 class="text-xl font-medium text-white" id="content-log-modal-title">Registar Conteúdos da Sessão</h3>
                     <button onclick="window.hideContentLogModal()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                 </div>
                 <div id="content-log-checkboxes" class="space-y-4 overflow-y-auto max-h-[60vh]">
                     {/* <!-- Checkboxes will be rendered here --> */}
                 </div>
                 <div class="mt-6 flex justify-between items-center">
                     <button id="delete-content-log-btn" class="btn btn-danger">Apagar Registo</button>
                     <button id="save-content-log-btn" class="btn btn-primary">Guardar</button>
                 </div>
             </div>
         </div>

         <div id="exercise-library-modal" class="modal fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
             <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-4xl transform transition-all">
                 <div class="flex justify-between items-center mb-4">
                     <h3 class="text-xl font-medium text-white">Adicionar Exercício da Biblioteca</h3>
                     <button onclick="window.hideExerciseLibraryModal()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                 </div>
                 <div class="mb-4">
                     <input type="text" id="library-search-input" placeholder="Pesquisar exercícios..." class="w-full text-sm bg-gray-700 border-gray-600 rounded-md py-2 px-3 text-white">
                 </div>
                 <div id="library-modal-list-container" class="space-y-2 overflow-y-auto max-h-[60vh]">
                     {/* <!-- Exercises will be rendered here --> */}
                 </div>
             </div>
         </div>

         <div id="confirmation-modal" class="modal fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
             <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-sm">
                 <h3 class="text-lg font-medium text-white" id="confirm-title">Tem a certeza?</h3>
                 <p class="text-sm text-gray-400 mt-2" id="confirm-message">Esta ação não pode ser revertida.</p>
                 <div class="mt-6 flex justify-end space-x-3">
                     <button id="confirm-cancel-btn" class="btn btn-secondary">Cancelar</button>
                     <button id="confirm-action-btn" class="btn btn-danger">Apagar</button>
                 </div>
             </div>
         </div>

         <div id="firebase-rules-modal" class="modal fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
            <!-- ... (código do modal de regras existente) ... -->
             <div class="bg-gray-800 rounded-lg shadow-xl p-6 w-full max-w-2xl">
                 <div class="flex justify-between items-center">
                     <h3 class="text-lg font-medium text-yellow-400">Ação Necessária: Configurar Regras de Segurança</h3>
                     <button onclick="document.getElementById('firebase-rules-modal').classList.remove('flex')" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                 </div>
                 <p class="text-sm text-gray-300 mt-4">
                     Ocorreu um erro de permissão. Para poder enviar ficheiros (imagens/vídeos), precisa de atualizar as regras de segurança do <strong>Firebase Storage</strong> no seu projeto.
                 </p>
                 <p class="text-sm text-gray-300 mt-2">
                     Este passo é obrigatório e só precisa de ser feito uma vez.
                 </p>
                 <div class="mt-4">
                     <label class="block text-sm font-semibold text-gray-200 mb-1">Copie e cole estas regras na sua consola Firebase:</label>
                     <pre class="bg-gray-900 text-white p-3 rounded-md text-xs overflow-x-auto"><code>rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    match /artifacts/{appId}/users/{userId}/{allPaths=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    // Adicione esta regra para ficheiros públicos de exercícios
    match /public_exercises_media/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null; // Permite escrita a users autenticados
    }
     // Adicionar regra para a galeria pública (se aplicável, senão remover)
     // match /gallery_public/{allPaths=**} {
     //   allow read: if true;
     //   allow write: if request.auth != null;
     // }
  }
}</code></pre>
                 </div>
                 <p class="text-sm text-gray-400 mt-3"><strong>Onde colar:</strong> Firebase Console > Storage > Rules (Regras)</p>
                 <div class="mt-6 flex justify-end">
                     <button onclick="document.getElementById('firebase-rules-modal').classList.remove('flex')" class="btn btn-primary">Entendido</button>
                 </div>
             </div>
         </div>

         <!-- NOVO MODAL: Edição da Semana do Macrociclo -->
         <div id="edit-week-modal" class="modal fixed inset-0 bg-black bg-opacity-70 hidden items-center justify-center z-50 p-4">
            <div class="modal-content bg-gray-800 rounded-lg shadow-xl p-8 w-full max-w-lg transform transition-all">
                 <div class="flex justify-between items-center mb-6">
                     <h3 class="text-xl font-medium text-white" id="edit-week-modal-title">Editar Semana</h3>
                     <button onclick="window.hideEditWeekModal()" class="text-gray-400 hover:text-white text-3xl">&times;</button>
                 </div>
                 <div class="space-y-4">
                     <div>
                         <label for="week-microcycle" class="block text-sm font-medium text-gray-400 mb-1">Microciclo (U.T.)</label>
                         <select id="week-microcycle" class="w-full text-sm bg-gray-700 border-gray-600 rounded-md py-1 px-2 text-white h-[34px]">
                             <option value="">Nenhum</option>
                             <option value="AJ">Ajuste (AJ)</option>
                             <option value="CA">Carga (CA)</option>
                             <option value="IM">Impacto (IM)</option>
                             <option value="AT">Ativação (AT)</option>
                             <option value="CO">Competição (CO)</option>
                             <option value="RC">Recuperação (RC)</option>
                         </select>
                     </div>
                     <div>
                         <label for="week-objective" class="block text-sm font-medium text-gray-400 mb-1">Objetivo da Semana</label>
                         <textarea id="week-objective" rows="3" class="w-full text-sm bg-gray-700 border-gray-600 rounded-md py-1 px-2 text-white" placeholder="Descreva o objetivo principal desta unidade de treino..."></textarea>
                     </div>
                     <div>
                         <label class="block text-sm font-medium text-gray-400 mb-1">Plano de Treino Associado</label>
                         <div class="flex gap-2">
                             <select id="week-plan-select" class="w-full text-sm bg-gray-700 border-gray-600 rounded-md py-1 px-2 text-white h-[34px] flex-grow">
                                 <option value="">Nenhum plano associado</option>
                                 {/* <!-- Planos serão carregados aqui --> */}
                             </select>
                             <button onclick="window.createNewPlanForWeek()" class="btn btn-secondary text-sm h-[34px]">Criar Novo</button>
                         </div>
                         <p id="week-plan-link" class="text-xs text-indigo-400 hover:underline mt-1 cursor-pointer" style="display: none;">Ver Plano Associado</p>
                     </div>
                 </div>
                 <div class="mt-8 flex justify-end gap-3">
                    <button onclick="window.hideEditWeekModal()" class="btn btn-secondary">Cancelar</button>
                    <button id="save-week-details-btn" onclick="window.saveWeekDetails()" class="btn btn-primary">Guardar Alterações</button>
                </div>
            </div>
         </div>

        <div id="toast-container"></div>
    </div>
    <div id="loading-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <p class="text-white text-xl animate-pulse">A carregar aplicação...</p>
    </div>

    <!-- PDF Export Container -->
    <div id="pdf-export-container" class="hidden"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, setDoc, addDoc, getDoc, getDocs, deleteDoc, query, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

        // --- GLOBAL STATE & CONFIG ---
        // ... (código existente) ...
        const appId = 'taekwondo-planner-public';
         const firebaseConfig = { // ... (config existente) ...
             apiKey: "AIzaSyCZR7XPf5o1Tel_kjfATfNu9hu7vlZc8DA",
             authDomain: "apptkdplan.firebaseapp.com",
             projectId: "apptkdplan",
             storageBucket: "apptkdplan.appspot.com",
             messagingSenderId: "545125407318",
             appId: "1:545125407318:web:a8064dc609c5792564b9f7",
             measurementId: "G-Z9QR3EM3XG"
         };

         let db, auth, storage;
         let userId = null;
         let storageEnabled = false;
         let currentEditingPlanId = null;
         let currentEditingExerciseId = null;
         let currentSectionIdForAddingExercise = null;
         let currentPlanExerciseIndex = null;
         let confirmAction = () => {};
         let currentTrainingPlan = {};
         let allTrainingPlans = []; // Guardará todos os planos para o dropdown
         let contentLog = {};
         let contentChart = null;
         let currentSessionIndex = null; // Para o mapa de conteúdos
         let numberOfSessions = 140; // Default number of sessions for content map
         let isInitialLoad = true;
         let currentExerciseData = {};
         let isUploading = false;

         // ESTADO PARA O MACROCICLO
         let currentMacrociclo = {
             season: '',
             startDate: null,
             endDate: null,
             // Agora guarda detalhes por semana (unidade de treino)
             weeks: {}, // { 1: { weekStartDate: '...', microcycle: 'CA', objective: '...', planId: '...' }, 2: {...} }
             // Definições de Períodos e Mesociclos ainda guardadas separadamente
             periods: [], // { id: '...', name: "Preparatório", startWeek: 1, endWeek: 8, colorClass: 'period-preparatorio' }
             mesocycles: [], // { id: '...', name: "Base", startWeek: 1, endWeek: 4, colorClass: 'meso-base' }
             events: [] // { id: '...', name: "Competição X", week: 15, type: 'competition', colorClass: 'event-competition' }
         };
         let macrocicloDocId = null;
         let currentlyEditingWeekNumber = null; // Para saber qual semana estamos a editar no modal

         // Mapeamentos de nomes para classes CSS (para consistência)
         const periodClasses = {
            "Preparatório": "period-preparatorio",
            "Competitivo": "period-competitivo",
            "Transitório": "period-transitorio"
         };
         const mesocycleClasses = {
            "Base": "meso-base",
            "Desenvolvimento": "meso-desenvolvimento",
            "Controlo": "meso-controlo",
            "Competição": "meso-competicao",
            "Manutenção": "meso-manutencao"
         };
         const eventClasses = {
            "Competição": "event-competition",
            "Avaliação": "event-evaluation",
            "Outro": "event-other"
         };


         const intensityOptions = ["Fraca - 50%", "Baixa - 70%", "Média 70 a 85%", "Alta 85 a 95%", "Extrema 95 a 100%"];
         const defaultExerciseTypes = { /* ... (tipos existentes) ... */
            "Capacidades Físicas": ["Flexibilidade", "Velocidade", "Resistência", "Força"],
            "Capacidades Coordenativas": ["Jogo", "Coordenação", "Equilíbrio", "Ritmo", "Manipulação", "Exercícios gímnicos"],
            "Conteúdos Técnico Táticos": ["Seogi Kisul", "Son Kisul Makis", "Son Kisul Gongkiok", "Yonsok Dongkia", "Bal Kisul Chagis", "Bal Kisul Tuios", "Yonsok Chagui", "Poomsae", "Kyorugi Competição", "Kyorugi Demonstração", "Hooshinsul", "Sam bo Kyorugi", "Sam bo Kyorugi (Bal Kisul)"],
            "Capacidades Psicológicas/cognitivas": ["Atenção e Concentração", "Motivação e Autoconfiança", "Gestão de Stress e Ansiedade", "Imagética e Visualização", "Comunicação e Coesão de Grupo", "Autorregulação e Autocontrolo"]
        };
         let allExerciseTypes = JSON.parse(JSON.stringify(defaultExerciseTypes));
         let exerciseTypeCategories = Object.keys(allExerciseTypes);

         const planMetadataFields = [ /* ... (campos existentes) ... */
            { id: "Treinador", label: "Treinador", type: "text" }, { id: "Local", label: "Local", type: "text" }, { id: "Data", label: "Data", type: "date" }, { id: "Plano.Nº", label: "Plano Nº", type: "number" },
            { id: "Periodo", label: "Período", type: "select", options: ["Preparatório", "Competitivo", "Transitório"] },
            { id: "Mesociclo", label: "Mesociclo", type: "select", options: ["Base", "Desenvolvimento", "Controlo", "Competição", "Manutenção"] },
            { id: "Microciclo", label: "Microciclo", type: "select", options: ["Ajuste (AJ)", "Carga (CA)", "Impacto (IM)", "Ativação (AT)", "Competição (CO)", "Recuperação (RC)"] },
            { id: "Intensidade", label: "Intensidade", type: "select", options: intensityOptions },
            { id: "Volume", label: "Volume (min)", type: "number" }, { id: "Conteúdo", label: "Conteúdo", type: "select", options: ["Marcial", "Kyorugi", "Poomsae", "Infantil"] },
            { id: "Objectivo Geral", label: "Objectivo Geral", type: "textarea" }, { id: "Objectivo Especifico", label: "Objectivo Específico", type: "textarea" },
            { id: "Material", label: "Material", type: "textarea" }, { id: "Equipa", label: "Equipa", type: "text" }
        ];
         const trainingSections = [ /* ... (secções existentes) ... */ { id: "parteInicial", title: "Parte Inicial" }, { id: "partePrincipal", title: "Parte Principal" }, { id: "parteFinal", title: "Parte Final" } ];
         const exerciseFields = [ /* ... (campos existentes) ... */ { id: "name", label: "Nome do Exercício", type: "text" }, { id: "description", label: "Descrição", type: "textarea" }, { id: "organization", label: "Organização/Esquema", type: "textarea" }, { id: "successCriteria", label: "Critérios de Êxito", type: "textarea" } ];
         const staticExerciseLoadFields = [ /* ... (campos existentes) ... */ { id: "repeticoes", label: "Repetições", type: "text" }, { id: "series", label: "Séries", type: "text" }, { id: "pausa", label: "Pausa", type: "text" }, { id: "intensidade", label: "Intensidade", type: "select", options: intensityOptions }, { id: "tempo", label: "Tempo (min)", type: "text"} ];


        // --- FIREBASE & APP INITIALIZATION ---
        // ... (código existente) ...
         if (firebaseConfig && firebaseConfig.apiKey) {
              try {
                  const app = initializeApp(firebaseConfig);
                  db = getFirestore(app);
                  auth = getAuth(app);

                  if (firebaseConfig.storageBucket) {
                      storage = getStorage(app);
                      storageEnabled = true;
                  } else {
                      console.warn("Firebase storageBucket not in config. File uploads disabled.");
                  }

                  onAuthStateChanged(auth, user => {
                      if (user) {
                          userId = user.uid;
                          initApp();
                      } else {
                          signInAnonymously(auth).catch(err => {
                              console.error("Anonymous Sign In Error:", err);
                              document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500 text-center text-lg p-4">Falha na autenticação. Verifique se ativou o login anónimo e se autorizou o domínio na consola Firebase.</p>`;
                          });
                      }
                  });
              } catch (error) {
                  console.error("Firebase Init Error:", error);
                  document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500 text-xl">Erro ao iniciar. Verifique a consola.</p>`;
              }
          } else {
               document.getElementById('loading-overlay').innerHTML = `<p class="text-red-500 text-xl">Configuração do Firebase em falta.</p>`;
          }


        function initApp() {
            // ... (código existente) ...
            document.getElementById('user-id-display').innerText = userId;
             if (isInitialLoad) {
                 setupEventListeners();
                 populateTrainingPlanForm();
                 populateExerciseForm();
                 renderTrainingSections();
             }
             finishInitialLoad();

             listenForContentTypes();
             listenForExercises();
             listenForTrainingPlans(); // Este carrega allTrainingPlans
             listenForContentLog();
             listenForGalleryImages();
             listenForMacrociclos();
        }

        function finishInitialLoad() {
             // ... (código existente) ...
             if (isInitialLoad) {
                  showView('training-plans-list-view'); // Manter lista de planos como default inicial
                  document.getElementById('app').style.display = 'block';
                  document.getElementById('loading-overlay').style.display = 'none';
                  isInitialLoad = false;
              }
        }

        function setupEventListeners() {
            // ... (event listeners existentes para confirmação, pesquisa, mapa de conteúdos, menu mobile) ...
            document.getElementById('confirm-cancel-btn').addEventListener('click', hideConfirmationModal);
             document.getElementById('confirm-action-btn').addEventListener('click', () => {
                 if(confirmAction) confirmAction();
                 hideConfirmationModal();
             });
             document.getElementById('library-search-input').addEventListener('input', (e) => {
                 renderExerciseLibraryForSelection(e.target.value);
             });
              document.getElementById('generate-chart-btn').addEventListener('click', generateContentChart);
              document.getElementById('save-content-log-btn').addEventListener('click', saveContentLog);
              document.getElementById('add-sessions-btn').addEventListener('click', addMoreSessions);
              document.getElementById('delete-content-log-btn').addEventListener('click', deleteContentLog);
              document.getElementById('mobile-menu-button').addEventListener('click', window.toggleMobileMenu);
        }

        // --- VIEW MANAGEMENT ---
        // ... (código existente com adição do caso 'macrociclo-view') ...
         window.toggleMobileMenu = () => {
              const menu = document.getElementById('mobile-menu');
              menu.classList.toggle('hidden');
          };

          window.showView = (viewId) => {
              document.querySelectorAll('.view').forEach(el => el.classList.add('hidden'));
              const targetView = document.getElementById(viewId);
              if (targetView) {
                  targetView.classList.remove('hidden');
              } else {
                  console.error(`View with ID ${viewId} not found!`);
                  document.getElementById('training-plans-list-view').classList.remove('hidden');
              }


              document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
              let activeButtonId = '';
              switch(viewId) {
                  case 'training-plans-list-view': activeButtonId = 'nav-meus-planos'; break;
                  case 'macrociclo-view':
                      activeButtonId = 'nav-macrociclo';
                      renderMacrocicloGrid(); // Renderiza a grelha ao mostrar a view
                      break;
                  case 'training-plan-editor-view':
                      activeButtonId = currentEditingPlanId ? 'nav-meus-planos' : 'nav-novo-plano';
                      break;
                  case 'exercise-library-view': activeButtonId = 'nav-biblioteca'; break;
                  case 'exercise-editor-view':
                      activeButtonId = currentEditingExerciseId ? 'nav-biblioteca' : 'nav-novo-exercicio';
                      break;
                  case 'image-gallery-view': activeButtonId = 'nav-galeria'; break;
                  case 'content-map-view':
                      activeButtonId = 'nav-mapa';
                      renderContentGrid(); // Renderiza mapa de conteúdos
                      break;
              }
              const activeButton = document.getElementById(activeButtonId);
              if(activeButton) activeButton.classList.add('active');
          };

        // --- TRAINING PLAN LOGIC ---
        // Funções existentes (listenForTrainingPlans, seedInitialDataIfNeeded, create, edit, duplicate, saveExercisesToLibrary, save, delete, populateForm, renderHeader, updateHeader, renderSections, renderExercises, addExercise, updateExercise, removeExercise)
        // A função listenForTrainingPlans agora também popula `allTrainingPlans` para o dropdown do macrociclo.
        function listenForTrainingPlans() {
             if (!userId) return;
             const q = query(collection(db, `artifacts/${appId}/users/${userId}/training_plans`));
             onSnapshot(q, (snapshot) => {
                 const container = document.getElementById('plans-list-container');
                 if (snapshot.empty) {
                     container.innerHTML = '<p class="text-center text-gray-500">Ainda não criou nenhum plano. A criar um plano de exemplo...</p>';
                     seedInitialDataIfNeeded(); // Chama apenas se estiver vazio
                     allTrainingPlans = []; // Limpa a lista global
                     populateWeekPlanDropdown(); // Atualiza dropdown no modal do macrociclo
                     return;
                 }
                 // Guarda todos os planos para o dropdown
                 allTrainingPlans = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 allTrainingPlans.sort((a, b) => (b.header?.Data || '').localeCompare(a.header?.Data || ''));

                 container.innerHTML = allTrainingPlans.map(plan => `
                     <div onclick="window.editTrainingPlan('${plan.id}')" class="glass-effect rounded-lg p-4 flex justify-between items-center cursor-pointer hover:border-indigo-500 border border-transparent transition">
                         <div>
                             <h3 class="font-bold text-lg text-white">Plano Nº ${plan.header?.['Plano.Nº'] || 'N/A'} - ${plan.header?.Data || 'Sem data'}</h3>
                             <p class="text-sm text-gray-400">${plan.header?.['Objectivo Geral'] || 'Sem objectivo'}</p>
                         </div>
                         <div class="flex space-x-2">
                             <button onclick="event.stopPropagation(); window.duplicateTrainingPlan('${plan.id}')" class="btn btn-teal text-sm">Duplicar</button>
                             <button onclick="event.stopPropagation(); window.confirmDelete('plan', '${plan.id}')" class="btn btn-danger text-sm">Apagar</button>
                         </div>
                     </div>
                 `).join('');
                  populateWeekPlanDropdown(); // Atualiza dropdown no modal do macrociclo
             }, (error) => {
                 console.error("Error listening for plans:", error);
                 allTrainingPlans = []; // Limpa em caso de erro
                 populateWeekPlanDropdown();
             });
         }
        async function seedInitialDataIfNeeded() { /* ... */ }
        window.createNewTrainingPlan = () => { /* ... */ };
        window.editTrainingPlan = async (planId) => { /* ... */ };
        window.duplicateTrainingPlan = async (planId) => { /* ... */ };
        async function saveExercisesFromPlanToLibrary(plan) { /* ... */ }
        window.saveTrainingPlan = async () => { /* ... */ };
        window.deleteTrainingPlan = async (planId) => { /* ... */ };
        function populateTrainingPlanForm() { /* ... */ }
        function renderTrainingPlanHeader() { /* ... */ }
        window.updatePlanHeader = (fieldId, value) => { /* ... */ };
        function renderTrainingSections() { /* ... */ }
        function renderTrainingPlanExercises() { /* ... */ }
        window.addExerciseToPlan = (sectionId) => { /* ... */ };
        window.updateExerciseInPlan = (sectionId, index, field, value) => { /* ... */ };
        window.removeExerciseFromPlan = async (sectionId, index) => { /* ... */ };


        // --- IMAGE GALLERY LOGIC ---
        // ... (todo o código existente) ...
        function listenForGalleryImages() { /* ... */ }
        function renderImageGallery(images) { /* ... */ }
        function renderImageGalleryModal(images) { /* ... */ }
        window.handleGalleryUpload = async (file) => { /* ... */ };
        window.deleteGalleryImage = async (imageId) => { /* ... */ };
        window.showImageGalleryModal = (sectionId, index, forExercise = false) => { /* ... */ };
        window.hideImageGalleryModal = () => { /* ... */ };
        window.selectImageFromGallery = (url, type) => { /* ... */ };
        window.copyToClipboard = (text) => { /* ... */ };
        async function deleteFile(filePath) { /* ... */ }
        function updateCalculatedTotalTime() { /* ... */ }


        // --- EXERCISE LIBRARY LOGIC ---
        // ... (todo o código existente) ...
        function listenForContentTypes() { /* ... */ }
        function listenForExercises() { /* ... */ }
        window.saveExercise = async () => { /* ... */ };
        window.cancelExerciseEdit = async () => { /* ... */ };
        window.deleteExercise = async (exerciseId, suppressToast = false) => { /* ... */ };
        function populateExerciseForm() { /* ... */ }
        window.createNewExercise = async () => { /* ... */ };
        window.showExerciseEditor = async (exerciseId = null) => { /* ... */ };


        // --- CONTENT MAP LOGIC ---
        // ... (todo o código existente) ...
        function listenForContentLog() { /* ... */ }
        function renderContentGrid() { /* ... */ }
        async function addMoreSessions() { /* ... */ }
        window.showContentLogModal = (sessionIndex) => { /* ... */ };
        window.hideContentLogModal = () => { /* ... */ };
        window.addNewContentType = (category) => { /* ... */ };
        window.saveNewContentTypeHandler = async (category) => { /* ... */ };
        async function saveContentLog() { /* ... */ }
        async function deleteContentLog() { /* ... */ }
        function generateContentChart() { /* ... */ }


        // --- MACROCICLO LOGIC ---
        function listenForMacrociclos() {
             if (!userId) return;
              // Assume-se um único documento por utilizador para o macrociclo atual
              const docRef = doc(db, `artifacts/${appId}/users/${userId}/macrociclos`, 'current_season');
              onSnapshot(docRef, (docSnap) => {
                  if (docSnap.exists()) {
                      currentMacrociclo = docSnap.data();
                      macrocicloDocId = docSnap.id;
                      // Valida/Limpa dados carregados - crucial para evitar erros
                      currentMacrociclo.startDate = currentMacrociclo.startDate || null;
                      currentMacrociclo.endDate = currentMacrociclo.endDate || null;
                      currentMacrociclo.weeks = currentMacrociclo.weeks || {}; // Deve ser um objeto
                      currentMacrociclo.periods = Array.isArray(currentMacrociclo.periods) ? currentMacrociclo.periods : [];
                      currentMacrociclo.mesocycles = Array.isArray(currentMacrociclo.mesocycles) ? currentMacrociclo.mesocycles : [];
                      currentMacrociclo.events = Array.isArray(currentMacrociclo.events) ? currentMacrociclo.events : [];
                  } else {
                      // Se não existe, inicializa com a estrutura default
                      macrocicloDocId = 'current_season'; // Nome fixo para o doc
                      currentMacrociclo = {
                          season: '', startDate: null, endDate: null,
                          weeks: {}, periods: [], mesocycles: [], events: []
                       };
                  }
                  updateMacrocicloUI(); // Atualiza os inputs e a grelha
              }, (error) => {
                  console.error("Erro ao carregar macrociclo:", error);
                  // Em caso de erro, reverte para o default
                  macrocicloDocId = 'current_season';
                  currentMacrociclo = { season: '', startDate: null, endDate: null, weeks: {}, periods: [], mesocycles: [], events: [] };
                  updateMacrocicloUI();
              });
         }

         function updateMacrocicloUI() {
             // Atualiza os inputs de data e época
             document.getElementById('macro-season').value = currentMacrociclo.season || '';
             document.getElementById('macro-start-date').value = currentMacrociclo.startDate || '';
             document.getElementById('macro-end-date').value = currentMacrociclo.endDate || '';
             renderMacrocicloGrid(); // Re-renderiza a grelha com os dados atuais
         }

        // Função para atualizar o estado global do macrociclo quando os inputs mudam
        window.updateMacrocicloState = (field, value) => {
             if (currentMacrociclo) {
                 currentMacrociclo[field] = value;
                 // Se for data, limpa os detalhes das semanas antigas para forçar recálculo
                 if (field === 'startDate' || field === 'endDate') {
                     //currentMacrociclo.weeks = {}; // Opcional: resetar detalhes ao mudar intervalo?
                 }
             }
        }

        // Função auxiliar para obter os detalhes de uma semana específica
        // Retorna um objeto com { periodClass, mesoClass, microcycle, objective, planId, eventHtml }
        function getWeekDetails(weekNumber, weekStartDate) {
            const weekData = currentMacrociclo.weeks[weekNumber] || {};
            let details = {
                periodClass: 'period-undefined',
                mesoClass: 'meso-undefined',
                microcycle: weekData.microcycle || '-', // Mostra '-' se não definido
                objective: weekData.objective || '',
                planId: weekData.planId || null,
                eventHtml: ''
            };

            // Determinar Período
            const period = currentMacrociclo.periods.find(p => weekNumber >= p.startWeek && weekNumber <= p.endWeek);
            if (period) {
                details.periodClass = period.colorClass || 'period-undefined';
            }

            // Determinar Mesociclo
            const mesocycle = currentMacrociclo.mesocycles.find(m => weekNumber >= m.startWeek && weekNumber <= m.endWeek);
            if (mesocycle) {
                details.mesoClass = mesocycle.colorClass || 'meso-undefined';
            }

             // Determinar Eventos (na semana específica)
             currentMacrociclo.events.forEach(event => {
                 if (event.week === weekNumber) {
                    details.eventHtml += `<div class="event-dot ${event.colorClass || 'event-other'}" title="${event.name}"></div>`;
                 }
             });


            return details;
        }


        window.renderMacrocicloGrid = () => {
             const container = document.getElementById('macrociclo-grid-container');
             const startDateValue = currentMacrociclo.startDate;
             const endDateValue = currentMacrociclo.endDate;

             if (!startDateValue || !endDateValue) {
                 container.innerHTML = '<p class="text-gray-500 italic col-span-full text-center py-8">Defina as datas de início e fim para visualizar as semanas.</p>';
                 return;
             }

             let startDate, endDate;
             try {
                 startDate = dateFns.parseISO(startDateValue);
                 endDate = dateFns.parseISO(endDateValue);
                 if (!dateFns.isValid(startDate) || !dateFns.isValid(endDate)) throw new Error("Data inválida");
             } catch (e) {
                  container.innerHTML = '<p class="text-red-500 italic col-span-full text-center py-8">Formato de data inválido.</p>';
                  return;
             }

             if (dateFns.isBefore(endDate, startDate)) {
                 container.innerHTML = '<p class="text-orange-500 italic col-span-full text-center py-8">A Data de Fim não pode ser anterior à Data de Início.</p>';
                 return;
             }

             let gridHtml = '';
             let currentMonth = -1;
             let weekCounter = 1;

             // Gera as semanas do intervalo
             const weeksInterval = dateFns.eachWeekOfInterval({ start: startDate, end: endDate }, { weekStartsOn: 1 });

             // Garante que a estrutura weeks exista e inicializa se necessário
             if (!currentMacrociclo.weeks) currentMacrociclo.weeks = {};

             weeksInterval.forEach(weekStartDate => {
                 const weekEndDate = dateFns.endOfWeek(weekStartDate, { weekStartsOn: 1 });
                 if (dateFns.isBefore(weekEndDate, startDate)) return; // Pula semanas que terminam antes do início

                 // Garante que existe entrada para esta semana no objeto `weeks`
                 if (!currentMacrociclo.weeks[weekCounter]) {
                    currentMacrociclo.weeks[weekCounter] = { weekStartDate: dateFns.formatISO(weekStartDate, { representation: 'date' }) };
                 } else {
                     // Atualiza a data de início caso tenha mudado
                     currentMacrociclo.weeks[weekCounter].weekStartDate = dateFns.formatISO(weekStartDate, { representation: 'date' });
                 }


                 const month = dateFns.getMonth(weekStartDate);
                 if (month !== currentMonth) {
                     currentMonth = month;
                     const monthName = dateFns.format(weekStartDate, 'MMMM yyyy', { locale: dateFns.locale.pt });
                     gridHtml += `<h3 class="macro-month-header">${monthName.charAt(0).toUpperCase() + monthName.slice(1)}</h3>`;
                 }

                 // Obter detalhes visuais e de dados da semana
                 const weekDetails = getWeekDetails(weekCounter, weekStartDate);

                 gridHtml += `
                    <div class="macro-week ${weekDetails.periodClass} ${weekDetails.mesoClass}"
                         data-week-number="${weekCounter}"
                         onclick="window.openEditWeekModal(${weekCounter})">

                         <span class="week-number">S${weekCounter}</span>
                         <span class="microcycle">${weekDetails.microcycle}</span> {/* Mostra abreviatura */}
                         <span class="week-date">${dateFns.format(weekStartDate, 'dd/MM')}</span>
                         ${weekDetails.eventHtml} {/* Pontos de evento */}
                         ${weekDetails.objective ? '<div class="objective-indicator" title="Objetivo definido"></div>' : ''} {/* Indicador de Objetivo */}
                    </div>`;

                 weekCounter++;
             });

             // Limpa semanas no objeto `weeks` que já não pertencem ao intervalo atual
             const totalWeeksInInterval = weekCounter - 1;
             Object.keys(currentMacrociclo.weeks).forEach(key => {
                 if (parseInt(key) > totalWeeksInInterval) {
                     delete currentMacrociclo.weeks[key];
                 }
             });


             container.innerHTML = gridHtml || '<p class="text-gray-500 italic col-span-full text-center py-8">Não foi possível gerar as semanas para o intervalo selecionado.</p>';
        }

        // Abre o Modal para Editar Detalhes da Semana
        window.openEditWeekModal = (weekNumber) => {
             currentlyEditingWeekNumber = weekNumber;
             const weekData = currentMacrociclo.weeks[weekNumber] || {};
             const modal = document.getElementById('edit-week-modal');
             const title = document.getElementById('edit-week-modal-title');

             title.innerText = `Editar Semana S${weekNumber}`;

             // Preencher campos do modal
             document.getElementById('week-microcycle').value = weekData.microcycle || '';
             document.getElementById('week-objective').value = weekData.objective || '';

             // Preencher e selecionar o plano associado
             populateWeekPlanDropdown(weekData.planId);

             // Lógica para mostrar link se houver plano associado
             const planLink = document.getElementById('week-plan-link');
             if (weekData.planId) {
                planLink.style.display = 'block';
                planLink.onclick = () => window.editTrainingPlan(weekData.planId); // Define o clique para abrir o plano
             } else {
                 planLink.style.display = 'none';
                 planLink.onclick = null;
             }


             modal.classList.add('flex');
        };

        // Fecha o Modal de Edição da Semana
        window.hideEditWeekModal = () => {
            document.getElementById('edit-week-modal').classList.remove('flex');
            currentlyEditingWeekNumber = null; // Limpa a semana em edição
        };

        // Guarda os Detalhes da Semana (do Modal)
        window.saveWeekDetails = () => {
            if (currentlyEditingWeekNumber === null) return;

            const weekNumber = currentlyEditingWeekNumber;
            const microcycle = document.getElementById('week-microcycle').value;
            const objective = document.getElementById('week-objective').value;
            const planId = document.getElementById('week-plan-select').value;

            // Garante que a entrada da semana existe
            if (!currentMacrociclo.weeks[weekNumber]) {
                 // Tenta obter a data de início se possível (pode não estar disponível aqui diretamente)
                 // Se não, cria apenas com os dados do modal
                 currentMacrociclo.weeks[weekNumber] = {};
            }

            // Atualiza os dados da semana
            currentMacrociclo.weeks[weekNumber].microcycle = microcycle;
            currentMacrociclo.weeks[weekNumber].objective = objective;
            currentMacrociclo.weeks[weekNumber].planId = planId || null; // Guarda null se "Nenhum" for selecionado

            // Re-renderiza a grelha para mostrar as alterações visuais
            renderMacrocicloGrid();
            hideEditWeekModal(); // Fecha o modal
            // Nota: Não guarda no Firebase aqui, apenas atualiza o estado local.
            // O botão "Guardar Macrociclo" fará isso.
            showToast(`Detalhes da Semana S${weekNumber} atualizados localmente.`);
        };

        // Preenche o dropdown de planos no modal da semana
        function populateWeekPlanDropdown(selectedPlanId = null) {
            const select = document.getElementById('week-plan-select');
            if (!select) return; // Sai se o modal não estiver visível/pronto

            // Guarda a opção "Nenhum"
            const defaultOption = select.options[0];
            select.innerHTML = ''; // Limpa opções antigas
            select.appendChild(defaultOption); // Readiciona "Nenhum"

            allTrainingPlans.forEach(plan => {
                const option = document.createElement('option');
                option.value = plan.id;
                // Mostra Nº, Data e Objetivo para identificar o plano
                option.textContent = `Plano ${plan.header?.['Plano.Nº'] || '?'} (${plan.header?.Data || 's/d'}) - ${plan.header?.['Objectivo Geral']?.substring(0,30) || 's/obj'}...`;
                select.appendChild(option);
            });

            // Seleciona o plano que estava associado (se houver)
            if (selectedPlanId) {
                select.value = selectedPlanId;
            }
        }

        // Função chamada pelo botão "Criar Novo" no modal da semana
        window.createNewPlanForWeek = async () => {
            if (currentlyEditingWeekNumber === null) return;

            // Cria um novo plano com dados básicos preenchidos
            const weekNumber = currentlyEditingWeekNumber;
            const weekStartDate = currentMacrociclo.weeks[weekNumber]?.weekStartDate;
            const dateForPlan = weekStartDate ? dateFns.formatISO(dateFns.parseISO(weekStartDate), { representation: 'date' }) : new Date().toISOString().split('T')[0];

            // Preenche alguns metadados do plano baseados no macrociclo/semana
            const period = currentMacrociclo.periods.find(p => weekNumber >= p.startWeek && weekNumber <= p.endWeek);
            const mesocycle = currentMacrociclo.mesocycles.find(m => weekNumber >= m.startWeek && weekNumber <= m.endWeek);
            const microcycle = currentMacrociclo.weeks[weekNumber]?.microcycle;

            // Cria um objeto de plano inicial
             currentEditingPlanId = null; // Garante que é um novo plano
             currentTrainingPlan = {
                 header: {
                     'Plano.Nº': `S${weekNumber}`, // Sugestão para Nº do Plano
                     'Data': dateForPlan,
                     'Periodo': period ? period.name : '',
                     'Mesociclo': mesocycle ? mesocycle.name : '',
                     'Microciclo': microcycle || '', // Preenche se definido na semana
                     // Outros campos podem ser preenchidos ou deixados em branco
                     'Objectivo Geral': currentMacrociclo.weeks[weekNumber]?.objective || '', // Usa objetivo da semana
                     'Treinador': '', 'Local': '', 'Intensidade': '', 'Volume': '', 'Conteúdo': '', 'Objectivo Especifico': '', 'Material': '', 'Equipa': ''
                 },
                 parteInicial: [], partePrincipal: [], parteFinal: []
             };

             // Guarda este novo plano no Firebase
             try {
                currentTrainingPlan.createdAt = serverTimestamp();
                const docRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/training_plans`), currentTrainingPlan);
                const newPlanId = docRef.id;

                // Associa o ID do novo plano à semana
                if (currentMacrociclo.weeks[weekNumber]) {
                     currentMacrociclo.weeks[weekNumber].planId = newPlanId;
                } else {
                     currentMacrociclo.weeks[weekNumber] = { planId: newPlanId };
                }

                showToast(`Novo plano criado e associado à Semana S${weekNumber}. A abrir editor...`);
                hideEditWeekModal(); // Fecha modal da semana
                await window.editTrainingPlan(newPlanId); // Abre o editor para o novo plano

             } catch (error) {
                 console.error("Erro ao criar novo plano para a semana:", error);
                 showToast("Erro ao criar o novo plano.", true);
             }
        };


        window.saveMacrociclo = async () => {
             // ... (código existente com validações) ...
             if (!userId || !macrocicloDocId) return;

              const macroToSave = { ...currentMacrociclo };

              if (!macroToSave.season || !macroToSave.startDate || !macroToSave.endDate) { /* ... validação ... */ }
              try {
                  const startDateObj = dateFns.parseISO(macroToSave.startDate);
                  const endDateObj = dateFns.parseISO(macroToSave.endDate);
                  if (!dateFns.isValid(startDateObj) || !dateFns.isValid(endDateObj)) throw new Error();
                  if (dateFns.isBefore(endDateObj, startDateObj)) throw new Error("End date before start date");
              } catch (e) {
                  showToast(e.message === "End date before start date" ? "A Data de Fim não pode ser anterior à Data de Início." : "Formato de data inválido.", true);
                  return;
              }

              updateSaveButtonState(true); // Desativa botão
              const toastId = showToast("A guardar macrociclo...", false, true);

              try {
                  const docRef = doc(db, `artifacts/${appId}/users/${userId}/macrociclos`, macrocicloDocId);
                  // Guarda o objeto completo atualizado
                  await setDoc(docRef, macroToSave);
                  showToast("Macrociclo guardado!", false, false, toastId);
              } catch (error) {
                  console.error("Erro ao guardar macrociclo:", error);
                  showToast("Erro ao guardar o macrociclo.", true, false, toastId);
              } finally {
                  updateSaveButtonState(false); // Reativa botão
              }
        }

        // --- Funções Placeholder para Gerir Períodos, Mesociclos, Eventos ---
         window.openPeriodModal = () => { showToast("Gestão de Períodos ainda não implementada.", true); };
         window.openMesocycleModal = () => { showToast("Gestão de Mesociclos ainda não implementada.", true); };
         window.openEventModal = () => { showToast("Gestão de Eventos ainda não implementada.", true); };

        // --- UTILITY FUNCTIONS ---
        // Funções existentes (showToast, Modals, confirmDelete, PDF export, updateSaveButtonState)
        function showFirebaseRulesModal() { /* ... */ }
        window.showExerciseLibraryModal = (sectionId) => { /* ... */ };
        window.hideExerciseLibraryModal = () => { /* ... */ };
        async function renderExerciseLibraryForSelection(filterText = '') { /* ... */ }
        window.addExerciseFromLibraryToPlan = async (exerciseId) => { /* ... */ };
        function showToast(message, isError = false, isLoading = false, id = null) { /* ... */ }
        function showConfirmationModal(titleText, messageText) { /* ... */ }
        function hideConfirmationModal() { /* ... */ }
        window.confirmDelete = (type, id) => { /* ... */ };
        window.exportPlanToPDF = () => { /* ... */ };

        // Atualiza estado visual do botão "Guardar Macrociclo" e outros botões de guardar
        function updateSaveButtonState(isSaving) {
             const saveMacroBtn = document.getElementById('save-macrociclo-btn');
             const savePlanBtn = document.getElementById('save-plan-btn');
             // Adicionar outros botões de guardar se necessário

             if (saveMacroBtn) {
                 saveMacroBtn.disabled = isSaving;
                 saveMacroBtn.textContent = isSaving ? 'A guardar...' : 'Guardar Macrociclo';
             }
             if (savePlanBtn) {
                 // Pode ser necessário verificar `isUploading` aqui também
                 savePlanBtn.disabled = isSaving || isUploading;
                 savePlanBtn.textContent = (isSaving || isUploading) ? 'A guardar...' : 'Guardar Plano';
             }
             // ... desativar/reativar outros botões
         }

    </script>
</body>
</html>

